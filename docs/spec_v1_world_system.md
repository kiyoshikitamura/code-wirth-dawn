World System Specification v2.0
1. 概要 (Overview)
Code: Wirth-Dawn における世界は、静的な背景ではなく、全プレイヤーの行動集計によって24時間ごとに物理的に書き換わる「巨大な共有ステート」である。 本ドキュメントは、国家間の覇権争い、拠点の興亡、およびそれらが個人のバトルや経済に与える影響のロジックを定義する。

--------------------------------------------------------------------------------
2. 世界構造と4大国家 (World Structure)
世界は4つの根源的イデオロギー（属性）と、それを象徴する4大国家によって分割統治されている。
国家名
属性 (Alignment)
首都 (Capital)
文化・特徴
ローラン聖帝国
Order (秩序)
王都レガリア
中世欧州風。騎士道と法による統治。
砂塵の王国マルカンド
Chaos (混沌)
黄金都市イスハーク
中世アラブ風。交易と錬金術、自由競争。
夜刀神国 (やとの特国)
Justice (正義)
神都「出雲」
中世日本風。神話と義、呪術的調和。
華龍神朝 (かりゅうしんちょう)
Evil (悪)
天極城「龍京」
中世中華風。力と実利、覇道による支配。

--------------------------------------------------------------------------------
3. 世界変遷サイクル (The 24h Cycle)
サーバーは24時間ごとに以下のプロセスを実行し、世界の状態（World State）を更新する。
3.1 集計フェーズ (Aggregation)
全プレイヤーの以下のログを集計し、各拠点（全20箇所）の属性値を更新する。
• Clear Log: 依頼達成による属性変動。
• Prayer Log: 「祈り（通貨消費）」による直接干渉。
3.2 領土遷移ロジック (Territory Shift)
1. Global Power: 全拠点の属性合計比率を算出。
2. Expansion: 比率が高い国家は、首都から物理的距離が近い隣接拠点を自国領として併合する。
3. Resistance: ただし、拠点の「地域属性値」が侵攻国の属性と極端に反発する場合、併合は失敗するか、または「崩壊」状態で併合される。
3.3 歴史の確定と出力 (History & SNS)
• 号外生成: 領土の変更や、劇的な属性変化があった場合、LLMがニュース見出しを作成。
• SNS Post: 公式Xアカウントが「号外画像」を自動投稿する（Vercel OG連携）。

--------------------------------------------------------------------------------
4. 拠点ロジック (Location Logic)
各拠点は独立したパラメータを持ち、プレイヤーの経済活動とバトルに直接干渉する。
4.1 繁栄度ステータス (Prosperity Levels)
拠点の状態は5段階で管理される。
状態
名称
条件・影響
Lv 5
絶頂 (Zenith)
支配国と地域属性が完全に一致。<br>最高の品揃え、ボーナスカード支給。
Lv 4
繁栄 (Prosperous)
安定状態。<br>通常価格。
Lv 3
停滞 (Stagnant)
わずかな摩擦。<br>品揃え減少。
Lv 2
衰退 (Declining)
支配国への反発増。<br>物価高騰（x1.5）、宿屋の回復量低下。
Lv 1
崩壊 (Ruined)
[危険] 統治機能の喪失。<br>ショップ利用不可、バトルへのノイズ混入。
4.2 統治摩擦 (Alignment Friction)
繁栄度は以下のロジックで毎日再計算される。
Friction = ABS( RulingNation.Attribute - Location.Attribute )
// 摩擦係数が高い（支配国の思想と、その土地の民意がズレている）ほど、繁栄度は低下に向かう。

--------------------------------------------------------------------------------
5. バトル・経済への介入 (Interaction)
世界の状態は、プレイヤー個人のゲームプレイに以下の形で介入する。
5.1 World Deck Injection (環境カード介入)
v2.0バトルシステムに基づき、拠点の状態がプレイヤーのデッキを汚染、あるいは支援する。
• 繁栄・絶頂時:
    ◦ Support Card（市民の支援、配給食料など）がデッキに混ざる可能性がある。
• 崩壊（Ruined）時:
    ◦ Noise Card（Fear, Debris, Despair）が強制的にデッキにインジェクトされる。
    ◦ これらはコストを払って廃棄しない限り手札を圧迫し、使用しても何の効果もない（または自傷する）。
5.2 ダイナミック・エコノミー
• 価格変動: 繁栄度が低いほど物価が上昇（インフレ）する。
• 限定品: 特定の国家が支配している期間のみ、その文化圏固有のスキル（例：マルカンド支配時の「錬金術」）がショップに並ぶ。

--------------------------------------------------------------------------------
6. プレイヤーとの社会的相互作用
6.1 名声 (Reputation)
• 名声は「世界共通」ではなく**「拠点ごと」**に管理される。
• 聖帝国で英雄（名声高）であっても、敵対する華龍神朝の領土では「指名手配犯（名声低）」として扱われ、施設利用が制限される。
6.2 祈り (Prayer)
• プレイヤーは通貨（Assets）を消費して、特定の拠点の属性値に直接ブーストをかけることができる。
• これにより、「推しの国」の領土拡大を支援したり、「故郷の街」が崩壊するのを防ぐことができる。

--------------------------------------------------------------------------------
7. Implementation Notes (Supabase)
テーブル構造: locations
create table locations (
  id uuid primary key,
  name text not null,
  ruling_nation_id text references nations(id), -- 現在の支配国
  base_attributes jsonb, -- {order: 100, chaos: 20...} その土地本来の性質
  current_attributes jsonb, -- プレイヤー行動により変動した現在値
  prosperity_level int check (prosperity_level between 1 and 5), -- 1=Ruined, 5=Zenith
  background_url text, -- 繁栄度によって画像URLを切り替える
  updated_at timestamp with time zone
);
バッチ処理要件
• 毎日00:00 (UTC) に calculate_world_transition 関数を実行すること。
• 処理順序:
    1. 全 prayer_logs と battle_logs を集計し current_attributes を更新。
    2. ruling_nation_id の遷移判定（領土拡大ロジック）。
    3. prosperity_level の再計算（摩擦ロジック）。
    4. 変更があった拠点のリストを作成し、SNS投稿BotへTriggerを送信。