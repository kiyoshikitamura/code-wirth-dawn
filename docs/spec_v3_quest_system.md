Code: Wirth-Dawn Specification v11.0 (Revised based on actual implementation)
# Quest System — Inventory & Moral Choices

## 1. 概要 (Overview)
本仕様書は、クエスト中の在庫管理（インベントリ）と道徳的選択（裏切りメカニクス）を定義する。

<!-- v11.1: inventoryテーブルの実装に合わせてスキーマ改訂。裏切り・アイテム判定の実装を反映。 -->

---

## 2. アイテム種別

| 種別 | type 値 | 説明 |
|---|---|---|
| 消耗品 | `consumable` | バトル中1回使用で消滅 |
| 取引品 | `trade_good` | 売却専用。ゲーム的効果なし |
| スキル | `skill` | デッキに組み込み可能 |
| キーアイテム | `key_item` | クエスト進行に必要。売却不可 |

---

## 3. データ構造

### 3.1 items テーブル
<!-- v11.0: 実装のitemsテーブルを反映 -->
```sql
CREATE TABLE items (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  slug TEXT UNIQUE,
  name TEXT NOT NULL,
  type TEXT DEFAULT 'consumable',  -- 'consumable', 'trade_good', 'skill', 'key_item'
  base_price INT DEFAULT 100,      -- 基本価格 (購入時)
  effect_data JSONB,               -- { description, power, target_type, ... }
  is_skill BOOLEAN DEFAULT FALSE,  -- trueの場合デッキ装備可能
  description TEXT,
  rarity TEXT DEFAULT 'common'
);
```

> **Note (v11.0)**: 旧仕様の `cost` は `base_price` として実装。`is_skill` フラグでデッキ装備可否を制御。

### 3.2 inventory テーブル
<!-- v11.0: 実装のinventoryテーブルを反映（旧仕様のuser_inventoryとは異なる） -->
```sql
CREATE TABLE inventory (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id),
  item_id BIGINT REFERENCES items(id),
  quantity INT DEFAULT 1,
  is_equipped BOOLEAN DEFAULT FALSE,
  is_ugc BOOLEAN DEFAULT FALSE,       -- UGC産アイテムフラグ（売却額制限用）
  acquired_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

> **Note (v11.0)**: 旧仕様では `(user_id, item_id)` の複合PKだったが、実装では各行がUUID PKを持つ。これにより同一アイテムの複数行保持が可能（購入するたびに新行が追加される）。

### 3.3 フロントエンド型定義
<!-- v11.0: API応答のフラット化後のインベントリ型 -->
```typescript
export interface InventoryItem {
  id: string;           // inventory.id (UUID)
  item_id: number;      // items.id (BIGINT)
  name: string;         // items.name (flattened)
  base_price: number;   // items.base_price (flattened)
  type: string;         // items.type
  is_equipped: boolean;
  is_skill: boolean;
  effect_data: any;
}
```

---

## 4. インベントリAPI

### 4.1 GET /api/inventory
- **認証**: `Authorization` ヘッダーから JWT を取得。
- **レスポンス**: `inventory` テーブルと `items` テーブルを JOIN し、フラット化した配列を返却。
- **フラット化マッピング**: `items!inner(*)` でインナージョイン。`item.name → name`, `item.base_price → base_price` 等。

### 4.2 PATCH /api/inventory
<!-- v11.0: 装備トグルの実装（bug fix後の正式仕様）を反映 -->
- **用途**: アイテムの装備/解除。
- **認証**: `x-user-id` ヘッダーで対象ユーザーを特定。
- **Body**: `{ item_id: string, is_equipped: boolean }`
- **フィルタ**: `user_id` で絞り込み（旧実装の `.is('user_id', null)` は修正済み）。

---

## 5. 裏切りシステム (Betrayal Mechanic)
<!-- v11.1: 実装済み -->

### 5.1 概要
クエスト中に取得または要求された `key_item` / `trade_good` / `consumable` 等のアイテムをショップで売却すると「裏切り」と判定される機能。

### 5.2 トリガー条件
- `/api/shop/sell` 呼び出し時に、ユーザーが現在クエストを受注中（`current_quest_id` が存在）であること。
- 売却するアイテムが、そのクエストに関連していること（クエストの `requirements.has_item` に指定されている、または `flow_nodes` 内で当該 `item_id` が使用されている）。
- ShopModalにて警告ダイアログが表示され、承諾した場合に成立する。

### 5.3 裏切りの結果
- アクティブなクエストが即座に **失敗** となる（`user_profiles.current_quest_id` をクリア）。
- 現在の拠点の名声 (Reputation) に中程度〜大幅なマイナス（例: -50 ポイント）。
- 売却金額自体は取得でき、ショップモーダルからクエスト失敗のリザルト画面（または Inn 画面へクエ失敗パラメータ付きで遷移）に移行される。

### 5.4 重度ペナルティ (UGC/Economy Defense)
裏切り等により名声が一定値以下に落ち込んだ場合、以下の致命的なペナルティが課される。
- **取引停止・出禁 (名声 0 未満)**:
  - 対象拠点において、「ショップでの売買」「酒場での残影雇用」「宿屋での休息」がブロック (HTTP 403 / UI無効化) される。
  - 解除には、別拠点での名声回復や、多額の「祈り（罰金）」の支払いが必要。
- **賞金稼ぎの襲撃 (名声 -100 以下)**:
  - 対象拠点を出発する移動（Travel）を実行した際、確定でエリートNPC「賞金稼ぎ (Bounty Hunters)」による襲撃バトルノードへ強制遷移する。
  - このバトルに敗北した場合、強制的な「リタイア（Vitality 0）」は免除される代わり、**現在の所持ゴールドの半分（または全額）を没収**される（経済防衛メカニクス）。

---

## 6. 納品 / 所持判定ノード
<!-- v11.1: 実装済み -->

| ノードタイプ | 用途 | 条件 | API連動 |
|---|---|---|---|
| `check_delivery` | 納品クエストの進行・成功判定 | 指定アイテム（`item_id`、`quantity`）が在庫にあるか | 成功時、`/api/inventory/consume` を叩きアイテムを消費する (但し `remove_on_success=false` の場合は除く) |
| `check_possession` | 特定アイテム所持をトリガーとする分岐判定 | 指定アイテム（`item_id`、`quantity`）が在庫にあるか | アイテムの消費は行わない |

実装箇所: `ScenarioEngine.tsx` のノードプロセッサーにおいて、`inventory` 状態との照合により実行される。持っていない場合は `fallback` または別経路ノードへ分岐する。