Code: Wirth-Dawn Specification v11.0 (Revised based on actual implementation)
# Quest System — Inventory & Moral Choices

## 1. 概要 (Overview)
本仕様書は、クエスト中の在庫管理（インベントリ）と道徳的選択（裏切りメカニクス）を定義する。

<!-- v11.0: inventoryテーブルの実装に合わせてスキーマ改訂。裏切りシステムの未実装を明記。 -->

---

## 2. アイテム種別

| 種別 | type 値 | 説明 |
|---|---|---|
| 消耗品 | `consumable` | バトル中1回使用で消滅 |
| 取引品 | `trade_good` | 売却専用。ゲーム的効果なし |
| スキル | `skill` | デッキに組み込み可能 |
| キーアイテム | `key_item` | クエスト進行に必要。売却不可 |

---

## 3. データ構造

### 3.1 items テーブル
<!-- v11.0: 実装のitemsテーブルを反映 -->
```sql
CREATE TABLE items (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  slug TEXT UNIQUE,
  name TEXT NOT NULL,
  type TEXT DEFAULT 'consumable',  -- 'consumable', 'trade_good', 'skill', 'key_item'
  base_price INT DEFAULT 100,      -- 基本価格 (購入時)
  effect_data JSONB,               -- { description, power, target_type, ... }
  is_skill BOOLEAN DEFAULT FALSE,  -- trueの場合デッキ装備可能
  description TEXT,
  rarity TEXT DEFAULT 'common'
);
```

> **Note (v11.0)**: 旧仕様の `cost` は `base_price` として実装。`is_skill` フラグでデッキ装備可否を制御。

### 3.2 inventory テーブル
<!-- v11.0: 実装のinventoryテーブルを反映（旧仕様のuser_inventoryとは異なる） -->
```sql
CREATE TABLE inventory (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id),
  item_id BIGINT REFERENCES items(id),
  quantity INT DEFAULT 1,
  is_equipped BOOLEAN DEFAULT FALSE,
  acquired_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

> **Note (v11.0)**: 旧仕様では `(user_id, item_id)` の複合PKだったが、実装では各行がUUID PKを持つ。これにより同一アイテムの複数行保持が可能（購入するたびに新行が追加される）。

### 3.3 フロントエンド型定義
<!-- v11.0: API応答のフラット化後のインベントリ型 -->
```typescript
export interface InventoryItem {
  id: string;           // inventory.id (UUID)
  item_id: number;      // items.id (BIGINT)
  name: string;         // items.name (flattened)
  base_price: number;   // items.base_price (flattened)
  type: string;         // items.type
  is_equipped: boolean;
  is_skill: boolean;
  effect_data: any;
}
```

---

## 4. インベントリAPI

### 4.1 GET /api/inventory
- **認証**: `Authorization` ヘッダーから JWT を取得。
- **レスポンス**: `inventory` テーブルと `items` テーブルを JOIN し、フラット化した配列を返却。
- **フラット化マッピング**: `items!inner(*)` でインナージョイン。`item.name → name`, `item.base_price → base_price` 等。

### 4.2 PATCH /api/inventory
<!-- v11.0: 装備トグルの実装（bug fix後の正式仕様）を反映 -->
- **用途**: アイテムの装備/解除。
- **認証**: `x-user-id` ヘッダーで対象ユーザーを特定。
- **Body**: `{ item_id: string, is_equipped: boolean }`
- **フィルタ**: `user_id` で絞り込み（旧実装の `.is('user_id', null)` は修正済み）。

---

## 5. 裏切りシステム (Betrayal Mechanic)
<!-- v11.0: 未実装であることを明記 -->

> **⚠️ 未実装 (v11.0時点)**
>
> 仕様定義のみ。将来的に以下のロジックを実装予定。

### 5.1 概要
クエスト中に取得した `key_item` をショップで売却すると「裏切り」と判定される。

### 5.2 トリガー条件
- `item.type === 'key_item'`
- 当該アイテムがアクティブなクエストの報酬または納品物

### 5.3 裏切りの結果
- アクティブなクエストが即座に **失敗** となる。
- 名声 (Reputation) に大幅なマイナス。
- 売却金額は取得できる。

---

## 6. 納品 / 所持判定ノード
<!-- v11.0: 未実装であることを明記 -->

> **⚠️ 未実装 (v11.0時点)**

| ノードタイプ | 用途 | 条件 |
|---|---|---|
| `check_delivery` | 納品クエストの成功判定 | 指定アイテムが在庫にあるか |
| `check_possession` | 特定アイテム所持をトリガーとする分岐 | 指定アイテムが在庫にあるか |

実装時は `ScenarioEngine.processNode()` に条件分岐を追加予定。